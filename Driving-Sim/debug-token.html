<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Debug - Driving Simulator</title>
    
    <!-- Load Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        pre {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç Token Debug - Driving Simulator</h1>
    
    <div class="debug-section">
        <h3>Current Token Status</h3>
        <div id="tokenStatus">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>Script Analysis</h3>
        <div id="scriptAnalysis">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>Actions</h3>
        <button onclick="reloadScript()">Reload Script</button>
        <button onclick="testTokenInjection()">Test Token Injection</button>
        <button onclick="analyzeTokenFromScript()">Check Script File</button>
        <button onclick="simulateGitHubActions()">Simulate GitHub Actions</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div class="debug-section">
        <h3>Console Output</h3>
        <pre id="consoleOutput">Check browser console for detailed output...</pre>
    </div>

    <script>
        // Capture console output
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        let consoleMessages = [];

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            consoleOutput.textContent = consoleMessages.slice(-20).join('\n');
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function analyzeToken() {
            const tokenStatus = document.getElementById('tokenStatus');
            let statusHtml = '';
            
            // Check if mapboxgl is loaded
            if (typeof mapboxgl === 'undefined') {
                statusHtml = '<div class="error">‚ùå Mapbox GL JS not loaded yet</div>';
                statusHtml += '<p>Waiting for Mapbox GL JS to load...</p>';
                tokenStatus.innerHTML = statusHtml;
                
                // Try again after a short delay
                setTimeout(analyzeToken, 1000);
                return;
            }
            
            const token = mapboxgl.accessToken;
            
            if (!token || token === '') {
                statusHtml = '<div class="error">‚ùå Token is empty or undefined</div>';
            } else if (token.startsWith('pk.')) {
                statusHtml = '<div class="success">‚úÖ Token appears to be valid (starts with pk.)</div>';
            } else {
                statusHtml = '<div class="warning">‚ö†Ô∏è Token does not start with pk. - may be invalid</div>';
            }
            
            statusHtml += `
                <pre>
Token value: "${token}"
Token length: ${token ? token.length : 0}
Token type: ${typeof token}
Token starts with pk.: ${token ? token.startsWith('pk.') : false}
                </pre>
            `;
            
            tokenStatus.innerHTML = statusHtml;
        }

        function analyzeTokenFromScript() {
            const tokenStatus = document.getElementById('tokenStatus');
            
            fetch('script.js')
                .then(response => response.text())
                .then(content => {
                    // Extract token from script content
                    const tokenMatch = content.match(/mapboxgl\.accessToken\s*=\s*['"`]([^'"`]*)['"`]/);
                    const token = tokenMatch ? tokenMatch[1] : null;
                    
                    let statusHtml = '<h4>Token from Script File:</h4>';
                    
                    if (!token || token === '') {
                        statusHtml += '<div class="error">‚ùå Token is empty in script file</div>';
                    } else if (token.startsWith('pk.')) {
                        statusHtml += '<div class="success">‚úÖ Token appears to be valid in script file</div>';
                    } else {
                        statusHtml += '<div class="warning">‚ö†Ô∏è Token does not start with pk. in script file</div>';
                    }
                    
                    statusHtml += `
                        <pre>
Token from script: "${token}"
Token length: ${token ? token.length : 0}
Token starts with pk.: ${token ? token.startsWith('pk.') : false}
                        </pre>
                    `;
                    
                    // Add to existing status
                    const currentStatus = tokenStatus.innerHTML;
                    tokenStatus.innerHTML = currentStatus + statusHtml;
                })
                .catch(error => {
                    const currentStatus = tokenStatus.innerHTML;
                    tokenStatus.innerHTML = currentStatus + `<div class="error">‚ùå Error reading script file: ${error.message}</div>`;
                });
        }

        function analyzeScript() {
            const scriptAnalysis = document.getElementById('scriptAnalysis');
            
            fetch('script.js')
                .then(response => response.text())
                .then(content => {
                    const lines = content.split('\n');
                    const tokenLine = lines.find(line => line.includes('mapboxgl.accessToken'));
                    const debugLines = lines.filter(line => line.includes('MAPBOX TOKEN DEBUG'));
                    
                    let analysisHtml = `
                        <h4>Script File Analysis:</h4>
                        <pre>Token line: ${tokenLine || 'Not found'}</pre>
                        <pre>Debug lines found: ${debugLines.length}</pre>
                        <pre>Total lines: ${lines.length}</pre>
                    `;
                    
                    if (debugLines.length > 0) {
                        analysisHtml += '<h4>Debug Lines:</h4><pre>' + debugLines.join('\n') + '</pre>';
                    }
                    
                    scriptAnalysis.innerHTML = analysisHtml;
                })
                .catch(error => {
                    scriptAnalysis.innerHTML = `<div class="error">‚ùå Error loading script.js: ${error.message}</div>`;
                });
        }

        function reloadScript() {
            console.log('Reloading script...');
            const script = document.createElement('script');
            script.src = 'script.js?' + Date.now();
            script.onload = () => {
                console.log('Script reloaded');
                analyzeToken();
            };
            script.onerror = () => {
                console.error('Failed to reload script');
            };
            document.head.appendChild(script);
        }

        function testTokenInjection() {
            console.log('Testing token injection...');
            if (typeof mapboxgl !== 'undefined') {
                const testToken = 'pk.test_token_123456789';
                mapboxgl.accessToken = testToken;
                console.log('Set test token:', testToken);
                analyzeToken();
            } else {
                console.error('Mapbox GL JS not loaded');
            }
        }

        function simulateGitHubActions() {
            console.log('=== SIMULATING GITHUB ACTIONS TOKEN INJECTION ===');
            
            // Simulate the token injection process
            const testToken = 'pk.test_token_from_github_actions_123456789';
            
            fetch('script.js')
                .then(response => response.text())
                .then(content => {
                    console.log('Original content token line:', content.split('\n').find(line => line.includes('mapboxgl.accessToken')));
                    
                    // Simulate the GitHub Actions replacement
                    const injectedContent = content.replace(/mapboxgl\.accessToken = '';/, `mapboxgl.accessToken = '${testToken}';`);
                    
                    console.log('Injected content token line:', injectedContent.split('\n').find(line => line.includes('mapboxgl.accessToken')));
                    
                    // Test if the injection would work
                    if (injectedContent.includes(testToken)) {
                        console.log('‚úÖ GitHub Actions simulation PASSED - token would be injected correctly');
                    } else {
                        console.log('‚ùå GitHub Actions simulation FAILED - token injection would not work');
                    }
                    
                    console.log('=== END SIMULATION ===');
                })
                .catch(error => {
                    console.error('Error simulating GitHub Actions:', error);
                });
        }

        function clearConsole() {
            consoleMessages = [];
            consoleOutput.textContent = 'Console cleared...';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Token debug page loaded');
            analyzeToken();
            analyzeTokenFromScript();
            analyzeScript();
        });
    </script>
</body>
</html>
